name: Deploy to WordPress by ID

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Send to WordPress
        run: |
          # 変更されたファイル（.md）を探す
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'content/wiki/.*\.md$' || true)
          for FILE in $FILES; do
            # ファイルの中から「WP_POST_ID: 数字」の部分を抜き出す
            POST_ID=$(grep -oP '(?<=WP_POST_ID: )\d+' "$FILE" || true)
            
            if [ -n "$POST_ID" ]; then
              # ファイルの全文を読み込む
              CONTENT=$(cat "$FILE" | jq -Rs .)
              
              echo "Updating WordPress Post ID: $POST_ID"
              
              # WordPress APIを叩いて、特定の記事IDを上書き更新する
              curl -X POST "${{ secrets.WP_URL }}wp-json/wp/v2/posts/$POST_ID" \
                -H "Authorization: Basic $(echo -n "${{ secrets.WP_USERNAME }}:${{ secrets.WP_PASSWORD }}" | base64)" \
                -H "Content-Type: application/json" \
                -d "{\"content\": $CONTENT, \"status\": \"publish\"}"
            else
              echo "No WP_POST_ID found in $FILE. Skipping."
            fi
          done
