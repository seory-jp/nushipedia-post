name: Deploy to WordPress

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Send to WordPress
        run: |
          # 変更されたファイル（.md）を探してWPに送信
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'content/wiki/.*\.md$' || true)
          for FILE in $FILES; do
            SLUG=$(basename "$FILE" .md)
            CONTENT=$(cat "$FILE" | jq -Rs .)
            
            # WordPress REST APIを使用して投稿を更新
            # ※本来はドキュメントID等で紐付けますが、まずはスラッグ一致で更新を試みます
            curl -X POST "${{ secrets.WP_URL }}wp-json/wp/v2/posts?slug=$SLUG" \
              -H "Authorization: Basic $(echo -n "${{ secrets.WP_USERNAME }}:${{ secrets.WP_PASSWORD }}" | base64)" \
              -H "Content-Type: application/json" \
              -d "{\"content\": $CONTENT, \"status\": \"publish\"}"
          done
